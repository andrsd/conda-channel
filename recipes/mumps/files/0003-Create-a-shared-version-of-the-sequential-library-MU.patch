From 5f98c74e99a992473ec24cda379a81941535c713 Mon Sep 17 00:00:00 2001
From: David Andrs <andrsd@gmail.com>
Date: Sun, 6 Aug 2023 13:50:18 -0600
Subject: [PATCH 3/5] Create a shared version of the sequential library, MUST
 BE LAST IN SERIES

---
 Makefile        |  1 +
 libseq/Makefile | 14 ++++++++------
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/Makefile b/Makefile
index 71161b3..e216711 100644
--- a/Makefile
+++ b/Makefile
@@ -48,6 +48,7 @@ prerequisites: Makefile.inc $(LIBSEQNEEDED) $(libdir)/libpord$(PLAT).a $(libdir)
 
 libseqneeded:
 	(cd libseq; $(MAKE))
+	cp libseq/lib* $(libdir)
 
 # Build the libpord.a library and copy it into $(topdir)/lib
 $(libdir)/libpord$(PLAT).a:
diff --git a/libseq/Makefile b/libseq/Makefile
index e4e0b6f..0ee64e4 100644
--- a/libseq/Makefile
+++ b/libseq/Makefile
@@ -8,15 +8,17 @@ all: libmpiseq
 
 include ../Makefile.inc
 
-libmpiseq: libmpiseq$(PLAT)$(LIBEXT)
+libmpiseq: libmpiseq$(PLAT).a libmpiseq$(PLAT)$(SHLIB_EXT)
 
-libmpiseq$(PLAT)$(LIBEXT): mpi.o mpic.o elapse.o
-	$(AR)$@ mpi.o mpic.o elapse.o
+libmpiseq$(PLAT).a: mpi.o mpic.o elapse.o
+	$(AR) $@ mpi.o mpic.o elapse.o
 	$(RANLIB) $@
+libmpiseq$(PLAT)$(SHLIB_EXT): mpi.o mpic.o elapse.o
+	$(FC) -shared $^ $(SONAME)libmpiseq$(PLAT)-$(PKG_VERSION)$(SHLIB_EXT) -o libmpiseq$(PLAT)-$(PKG_VERSION)$(SHLIB_EXT) $(LDFLAGS)
 .f.o:
-	$(FC) $(OPTF)              -c $*.f $(OUTF)$*.o
+	$(FC) $(OPTF)              -fPIC -c $*.f $(OUTF)$*.o
 .c.o:
-	$(CC) $(OPTC) $(CDEFS) -I. -c $*.c $(OUTC)$*.o
+	$(CC) $(OPTC) $(CDEFS) -I. -fPIC -c $*.c $(OUTC)$*.o
 
 clean:
-	$(RM) *.o *$(LIBEXT)
+	$(RM) *.o *.a *$(SHLIB_EXT)
-- 
2.39.2 (Apple Git-143)

